########################################################################################################################
# PUBLISH TO PYPI WORKFLOW
# Builds and publishes Python package to PyPI on release
# Based on abusix-parsers publishing standards
########################################################################################################################
name: Publish to PyPI

on:
  release:
    types: [published]
  workflow_dispatch:  # Allow manual trigger for testing
    inputs:
      test-pypi:
        description: 'Publish to Test PyPI instead of production'
        required: false
        default: 'true'
        type: boolean

permissions:
  contents: read       # Required for checkout
  id-token: write      # Required for trusted publishing to PyPI

jobs:
  build:
    name: "Build Distribution"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for setuptools_scm

      - name: Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Build Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine

      - name: Verify Package Metadata
        run: |
          echo "::group::Package Metadata"
          python -c "
          import tomllib
          with open('pyproject.toml', 'rb') as f:
              data = tomllib.load(f)
              project = data['project']
              print(f\"Package: {project['name']}")
              print(f\"Version: {project['version']}")
              print(f\"Description: {project['description']}")
          "
          echo "::endgroup::"

      - name: Build Distribution
        run: |
          echo "::group::Building Distribution"
          python -m build
          echo "::endgroup::"

      - name: List Distribution Files
        run: |
          echo "::group::Distribution Files"
          ls -lh dist/
          echo "::endgroup::"

      - name: Verify Distribution
        run: |
          echo "::group::Verifying Distribution"
          twine check dist/*
          echo "::endgroup::"

      - name: Upload Distribution Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/
          retention-days: 7

  publish-test-pypi:
    name: "Publish to Test PyPI"
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'workflow_dispatch' && inputs.test-pypi == true
    environment:
      name: test-pypi
      url: https://test.pypi.org/project/xarf-parser

    steps:
      - name: Download Distribution Artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish to Test PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          skip-existing: true
          verbose: true

  publish-pypi:
    name: "Publish to PyPI"
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'release'
    environment:
      name: pypi
      url: https://pypi.org/project/xarf-parser

    steps:
      - name: Download Distribution Artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          verbose: true

      - name: Create Release Comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const release = context.payload.release;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: release.number || 1,
              body: `ðŸ“¦ Package successfully published to PyPI!\n\n**Installation:**\n\`\`\`bash\npip install xarf-parser==${release.tag_name.replace('v', '')}\n\`\`\``
            });

  verify-installation:
    name: "Verify Installation"
    runs-on: ubuntu-latest
    needs: publish-test-pypi
    if: github.event_name == 'workflow_dispatch' && inputs.test-pypi == true

    steps:
      - name: Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Wait for Package Availability
        run: sleep 30

      - name: Install from Test PyPI
        run: |
          pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ xarf-parser

      - name: Verify Installation
        run: |
          python -c "import xarf; print(f'Successfully imported xarf version: {xarf.__version__}')"
