# XARF Python Library - Architecture Diagram

## System Overview

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         XARF Python Library                             │
│                           (Package: xarf)                               │
└─────────────────────────────────────────────────────────────────────────┘

                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼

        ┌───────────────┐  ┌────────────────┐  ┌──────────────────┐
        │  XARFParser   │  │ XARFValidator  │  │  XARFGenerator   │
        │               │  │                │  │                  │
        │ Parse JSON    │  │ Validate       │  │ Create Reports   │
        │ ▪ Strict mode │  │ ▪ Schema       │  │ ▪ Factory        │
        │ ▪ Batch       │  │ ▪ Business     │  │ ▪ Builder        │
        │ ▪ Multi-input │  │ ▪ Fields       │  │ ▪ Auto-populate  │
        └───────┬───────┘  └────────┬───────┘  └────────┬─────────┘
                │                   │                    │
                │                   │                    │
                └───────────────────┼────────────────────┘
                                    │
                                    ▼
                        ┌──────────────────────┐
                        │    Data Models       │
                        │   (Pydantic v2)      │
                        └──────────┬───────────┘
                                   │
                    ┌──────────────┼──────────────┬────────────────┐
                    │              │              │                │
                    ▼              ▼              ▼                ▼
        ┌─────────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────┐
        │   XARFReport    │ │ XARFReporter │ │   Evidence   │ │Validation│
        │     (Base)      │ │              │ │              │ │  Result  │
        └────────┬────────┘ └──────────────┘ └──────────────┘ └──────────┘
                 │
                 │
    ┌────────────┼────────────┬──────────────┬──────────────┐
    │            │            │              │              │
    ▼            ▼            ▼              ▼              ▼
┌─────────┐ ┌──────────┐ ┌─────────┐ ┌──────────────┐ ┌───────────┐
│Messaging│ │Connection│ │ Content │ │Infrastructure│ │ Copyright │
│ Report  │ │  Report  │ │ Report  │ │   Report     │ │  Report   │
└─────────┘ └──────────┘ └─────────┘ └──────────────┘ └───────────┘
                                      ┌──────────────┐ ┌───────────┐
                                      │Vulnerability │ │Reputation │
                                      │   Report     │ │  Report   │
                                      └──────────────┘ └───────────┘
```

## Component Interaction Flow

```
┌─────────────┐
│   User      │
│   Code      │
└──────┬──────┘
       │
       │ 1. Parse JSON
       ▼
┌────────────────────┐         ┌──────────────────┐
│   XARFParser       │────────▶│  XARFValidator   │
│                    │ 2. Val. │                  │
│ ▪ Load JSON        │◀────────│ ▪ Schema check   │
│ ▪ Detect category  │         │ ▪ Business rules │
│ ▪ Create object    │         │ ▪ Field formats  │
└─────────┬──────────┘         └──────────────────┘
          │                             ▲
          │ 3. Instantiate              │
          ▼                             │
┌──────────────────────┐                │
│  XARFReport Models   │                │
│                      │                │
│ ▪ MessagingReport    │────────────────┘
│ ▪ ConnectionReport   │  4. Validate
│ ▪ ContentReport      │
│ ▪ ...                │
└──────────────────────┘
          │
          │ 5. Return
          ▼
┌─────────────┐
│  Validated  │
│  Report     │
└─────────────┘
```

## Generation Flow

```
┌─────────────┐
│   User      │
│   Code      │
└──────┬──────┘
       │
       │ 1. Create
       ▼
┌────────────────────┐     ┌──────────────────┐
│  XARFGenerator     │     │  ReportBuilder   │
│                    │     │                  │
│ create_messaging() │ or  │ .set_category()  │
│ create_connection()│     │ .set_type()      │
│ create_content()   │     │ .build()         │
└─────────┬──────────┘     └────────┬─────────┘
          │                         │
          │ 2. Auto-populate        │
          │    ▪ report_id (UUID)   │
          │    ▪ timestamp (now)    │
          └────────┬────────────────┘
                   │
                   │ 3. Instantiate
                   ▼
        ┌──────────────────────┐
        │  XARFReport Models   │
        └──────────┬───────────┘
                   │
                   │ 4. Validate
                   ▼
        ┌──────────────────────┐
        │   XARFValidator      │
        └──────────┬───────────┘
                   │
                   │ 5. Return
                   ▼
        ┌──────────────────────┐
        │  Validated Report    │
        └──────────────────────┘
```

## Module Dependencies

```
┌────────────────────────────────────────────────────────────┐
│                      xarf/__init__.py                       │
│                    (Public API Surface)                     │
└────────────┬──────────────┬──────────────┬─────────────────┘
             │              │              │
    ┌────────▼─────┐ ┌─────▼──────┐ ┌────▼──────────┐
    │  parser.py   │ │validator.py│ │ generator.py  │
    │              │ │            │ │               │
    │ XARFParser   │ │XARFValidator│ │XARFGenerator  │
    └────┬─────────┘ └─────┬──────┘ └──────┬────────┘
         │                 │                │
         │       ┌─────────┼────────────────┘
         │       │         │
         │       │         │
    ┌────▼───────▼─────────▼────┐
    │      models.py             │
    │                            │
    │ ▪ XARFReport (base)        │
    │ ▪ MessagingReport          │
    │ ▪ ConnectionReport         │
    │ ▪ ContentReport            │
    │ ▪ XARFReporter             │
    │ ▪ Evidence                 │
    └────────────┬───────────────┘
                 │
    ┌────────────┼───────────────┐
    │            │               │
┌───▼─────────┐ │  ┌────────────▼──────┐
│exceptions.py│ │  │   utils/          │
│             │ │  │                   │
│XARFError    │ │  │ ▪ validators.py   │
│ ├─ParseError│ │  │ ▪ encoders.py     │
│ ├─Valid...  │ │  │ ▪ converters.py   │
│ ├─Schema... │ │  └───────────────────┘
│ └─Gener...  │ │
└─────────────┘ │
                │
        ┌───────▼────────┐
        │   schemas/     │
        │                │
        │ ▪ loader.py    │
        │ ▪ v4/*.json    │
        └────────────────┘
```

## Data Flow - Parsing

```
Input: JSON String/Dict/Bytes/Path
    │
    ▼
┌─────────────────────────┐
│ XARFParser.parse()      │
├─────────────────────────┤
│ 1. Decode input         │
│ 2. Validate JSON syntax │
│ 3. Load schema          │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ XARFValidator           │
├─────────────────────────┤
│ 1. Schema validation    │
│ 2. Field validation     │
│ 3. Business rules       │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ Detect category         │
├─────────────────────────┤
│ category = "messaging"  │
│    → MessagingReport    │
│ category = "connection" │
│    → ConnectionReport   │
│ category = "content"    │
│    → ContentReport      │
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ Pydantic instantiation  │
├─────────────────────────┤
│ 1. Type conversion      │
│ 2. Field validation     │
│ 3. Model validation     │
└───────────┬─────────────┘
            │
            ▼
Output: XARFReport (typed)
```

## Validation Levels

```
┌─────────────────────────────────────────────────────────┐
│                  Validation Pipeline                     │
└─────────────────────────────────────────────────────────┘

Level 1: JSON Schema Validation
├─ Structure check (required fields)
├─ Type validation (string, number, etc.)
├─ Format validation (date-time, uuid, etc.)
└─ Enum validation (literal values)
    │
    ▼
Level 2: Field Validation
├─ Email format (RFC 5322)
├─ IP address format (IPv4/IPv6)
├─ URL format (RFC 3986)
├─ UUID format (v4)
└─ Port ranges (1-65535)
    │
    ▼
Level 3: Business Rules
├─ Category-specific requirements
│  ├─ Messaging: smtp_from required for SMTP
│  ├─ Connection: destination_ip required
│  └─ Content: url required
├─ Type-specific requirements
│  ├─ spam/phishing: subject required
│  └─ login_attack: attempt_count recommended
└─ Cross-field validation
    │
    ▼
Level 4: Evidence Validation
├─ Content-type format
├─ Base64 encoding check
├─ Size limits (5MB per evidence)
└─ Count limits (10 max)
    │
    ▼
Result: ValidationResult
├─ is_valid: bool
├─ errors: List[dict]
└─ warnings: List[dict]
```

## Class Hierarchy Visualization

```
                    ┌─────────────────┐
                    │   BaseModel     │
                    │   (Pydantic)    │
                    └────────┬────────┘
                             │
         ┌───────────────────┼───────────────────┐
         │                   │                   │
    ┌────▼──────┐      ┌────▼─────┐      ┌─────▼────────┐
    │   XARF    │      │ Evidence │      │ Validation   │
    │ Reporter  │      │          │      │   Result     │
    └───────────┘      └──────────┘      └──────────────┘
                             │
                       ┌─────▼──────┐
                       │  XARFReport│
                       │   (Base)   │
                       └─────┬──────┘
                             │
         ┌───────────────────┼───────────────────┐
         │                   │                   │
    ┌────▼──────────┐  ┌────▼──────────┐  ┌────▼──────────┐
    │  Messaging    │  │  Connection   │  │   Content     │
    │   Report      │  │    Report     │  │   Report      │
    └───────────────┘  └───────────────┘  └───────────────┘
                             │
         ┌───────────────────┼───────────────────┐
         │                   │                   │
    ┌────▼──────────┐  ┌────▼──────────┐  ┌────▼──────────┐
    │Infrastructure │  │   Copyright   │  │Vulnerability  │
    │   Report      │  │    Report     │  │   Report      │
    └───────────────┘  └───────────────┘  └───────────────┘
                             │
                       ┌─────▼──────┐
                       │ Reputation │
                       │   Report   │
                       └────────────┘
```

## Exception Hierarchy

```
                    ┌──────────────┐
                    │  Exception   │
                    │  (Built-in)  │
                    └──────┬───────┘
                           │
                    ┌──────▼───────┐
                    │  XARFError   │
                    │   (Base)     │
                    └──────┬───────┘
                           │
         ┌─────────────────┼─────────────────┬──────────────┐
         │                 │                 │              │
    ┌────▼──────┐    ┌────▼──────┐    ┌────▼──────┐  ┌───▼──────┐
    │   XARF    │    │   XARF    │    │   XARF    │  │  XARF    │
    │ParseError │    │Validation │    │  Schema   │  │Generation│
    │           │    │  Error    │    │   Error   │  │  Error   │
    └───────────┘    └───────────┘    └───────────┘  └──────────┘
```

## Package Structure

```
xarf/
│
├── __init__.py           # Public API (all exports)
│   ├─ XARFParser
│   ├─ XARFValidator
│   ├─ XARFGenerator
│   ├─ ReportBuilder
│   ├─ XARFReport, MessagingReport, ...
│   └─ XARFError, XARFParseError, ...
│
├── parser.py             # Parse JSON to objects
│   └─ class XARFParser
│       ├─ parse()
│       ├─ parse_batch()
│       └─ get_errors()
│
├── validator.py          # Multi-level validation
│   ├─ class XARFValidator
│   │   ├─ validate()
│   │   ├─ validate_schema()
│   │   ├─ validate_business_rules()
│   │   └─ validate_evidence()
│   └─ class ValidationResult
│
├── generator.py          # Create reports
│   ├─ class XARFGenerator
│   │   ├─ create_messaging_report()
│   │   ├─ create_connection_report()
│   │   └─ create_content_report()
│   └─ class ReportBuilder
│       ├─ set_category()
│       ├─ set_type()
│       └─ build()
│
├── models.py             # Pydantic data models
│   ├─ class XARFReport (base)
│   ├─ class MessagingReport
│   ├─ class ConnectionReport
│   ├─ class ContentReport
│   ├─ class XARFReporter
│   └─ class Evidence
│
├── exceptions.py         # Exception hierarchy
│   ├─ class XARFError
│   ├─ class XARFParseError
│   ├─ class XARFValidationError
│   ├─ class XARFSchemaError
│   └─ class XARFGenerationError
│
├── constants.py          # Constants and enums
│   ├─ XARF_VERSION
│   ├─ VALID_CATEGORIES
│   ├─ VALID_TYPES
│   └─ EVIDENCE_SOURCES
│
├── schemas/              # JSON Schema files
│   ├── __init__.py
│   ├── loader.py
│   └── v4/
│       ├── base.json
│       ├── messaging.json
│       ├── connection.json
│       └── content.json
│
├── utils/                # Utilities
│   ├── __init__.py
│   ├── validators.py     # Email, IP, URL validators
│   ├── encoders.py       # Base64 encoding/decoding
│   └── converters.py     # Type converters
│
└── py.typed              # PEP 561 type marker
```

## Testing Structure

```
tests/
│
├── conftest.py           # Pytest fixtures
│
├── unit/                 # Unit tests (100% coverage)
│   ├── test_parser.py
│   ├── test_validator.py
│   ├── test_generator.py
│   ├── test_models.py
│   └── test_utils.py
│
├── integration/          # Integration tests
│   ├── test_end_to_end.py
│   └── test_schema_validation.py
│
├── performance/          # Performance benchmarks
│   ├── test_parsing_speed.py
│   └── test_memory_usage.py
│
├── fixtures/             # Test data
│   ├── valid/
│   │   ├── messaging_spam.json
│   │   ├── connection_ddos.json
│   │   └── content_phishing.json
│   └── invalid/
│       ├── missing_fields.json
│       └── invalid_types.json
│
└── shared/               # Shared test suite
    ├── samples/          # Official XARF samples
    └── test-definitions/ # Test case definitions
```

## Key Design Patterns

1. **Factory Pattern**: XARFGenerator
   - create_messaging_report()
   - create_connection_report()
   - create_content_report()

2. **Builder Pattern**: ReportBuilder
   - Fluent interface
   - Method chaining
   - Validation on build

3. **Strategy Pattern**: Validation
   - Different strategies per report class
   - Pluggable validators

4. **Template Method**: XARFReport
   - Base class defines template
   - Subclasses override validation

## Summary

This architecture provides:

✓ Clean separation of concerns
✓ Type-safe with Pydantic v2
✓ Extensible through inheritance
✓ Minimal dependencies (3 core)
✓ Comprehensive validation
✓ Performance optimized
✓ Well-tested (≥95% coverage)
✓ Fully documented
